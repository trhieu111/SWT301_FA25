Ok, m√¨nh s·∫Ω gi·∫£i th√≠ch chi ti·∫øt Use Case 15: View Clubs Statistics d·ª±a tr√™n code b·∫°n ƒë∆∞a, theo MVC flow v√† m·ªëi quan h·ªá gi·ªØa c√°c l·ªõp:

1Ô∏è‚É£ Goal

Ng∆∞·ªùi d√πng mu·ªën xem th·ªëng k√™ hi·ªáu su·∫•t c·ªßa CLB (ho·∫∑c t·∫•t c·∫£ CLB) trong m·ªôt m√πa gi·∫£i, bao g·ªìm:

Wins / Draws / Losses

Goals For / Goals Against

Points

Goal Difference

Win Rate

Ranking (n·∫øu xem t·∫•t c·∫£ CLB)

K·∫øt qu·∫£ l√† HTML ƒë√£ render (ClubStatistics.html ho·∫∑c ClubsStatistics.html) hi·ªÉn th·ªã b·∫£ng th·ªëng k√™.

2Ô∏è‚É£ Entry Points

Xem m·ªôt CLB c·ª• th·ªÉ:

GET /club/{clubId}/statistics?season=2025


Xem b·∫£ng x·∫øp h·∫°ng to√†n b·ªô CLB:

GET /clubs/statistics?season=2025


C√°c filter l√† t√πy ch·ªçn, m√πa gi·∫£i (season) c√≥ th·ªÉ b·ªè tr·ªëng ‚Üí l·∫•y t·∫•t c·∫£ d·ªØ li·ªáu.

3Ô∏è‚É£ Controller Layer
a) ClubStatisticsController

Nh·∫≠n clubId + season

G·ªçi ClubStatisticsService.getClubStatistics()

Th√™m model attribute: stats + season

Tr·∫£ v·ªÅ view ClubStatistics.html

b) ClubsRankingController

Nh·∫≠n season

G·ªçi ClubStatisticsService.getAllClubStatistics()

Th√™m model attribute: statsList + season

Tr·∫£ v·ªÅ view ClubsStatistics.html

Logic chung: Controller kh√¥ng th·ª±c hi·ªán t√≠nh to√°n, ch·ªâ nh·∫≠n params, g·ªçi Service v√† add v√†o Model.

4Ô∏è‚É£ Service Layer ‚Äî ClubStatisticsService

Chu·∫©n h√≥a season: trim + parse Integer

G·ªçi repository aggregation:

aggregateForClub() ‚Üí DTO ClubStatisticsView

aggregateForAll() ‚Üí List<DTO>

Enrich DTO:

matchesPlayed = wins + draws + losses

goalDifference = goalsFor - goalsAgainst

points = wins*3 + draws

winRate = wins / matchesPlayed

M·ª•c ƒë√≠ch: Gi·ªØ Service l√† n∆°i trung t√¢m x·ª≠ l√Ω business logic, repository ch·ªâ tr·∫£ d·ªØ li·ªáu raw.

5Ô∏è‚É£ Repository Layer ‚Äî ClubStatisticsRepo

D√πng JPQL aggregation:

sum(case when mcs.isWin = true then 1 else 0 end)
sum(case when mcs.isDraw = true then 1 else 0 end)
sum(case when mcs.isLoss = true then 1 else 0 end)
sum(mcs.goalsFor)
sum(mcs.goalsAgainst)


aggregateForClub() ‚Üí having c.clubId = :clubId

aggregateForAll() ‚Üí sort theo points (win*3 + draw)

Filter m√πa gi·∫£i: function('year', m.matchStartTime) = :season

DTO chuy·ªÉn d·ªØ li·ªáu ra view, tr√°nh l·ªô entity n·ªôi b·ªô.

L·ª£i √≠ch: T√≠nh to√°n tr√™n DB, kh√¥ng load c·∫£ list tr·∫≠n v·ªÅ Java ‚Üí hi·ªáu nƒÉng t·ªët.

6Ô∏è‚É£ Domain Model (Entities)

Club ‚Üí clubId, clubName

Match ‚Üí matchId, matchStartTime, relation matchClubStats

MatchClubStat ‚Üí match, club, primitive stats: goalsFor, goalsAgainst, isWin, isDraw, isLoss

Mapping n√†y cho ph√©p repository th·ª±c hi·ªán aggregation theo club + m√πa gi·∫£i.

7Ô∏è‚É£ DTO ‚Äî ClubStatisticsView

Truy·ªÅn d·ªØ li·ªáu ng·∫Øn g·ªçn v√† an to√†n cho view:

Raw: wins, draws, losses, goalsFor, goalsAgainst

Derived: matchesPlayed, goalDifference, points, winRate

L·ª£i √≠ch: Kh√¥ng expose entity ra view ‚Üí gi·∫£m coupling, tr√°nh lazy loading issues.

8Ô∏è‚É£ View Layer (Thymeleaf)

Nh·∫≠n model attribute stats ho·∫∑c statsList

Hi·ªÉn th·ªã b·∫£ng th·ªëng k√™: wins, draws, losses, GF, GA, points, goalDifference, winRate

C√≥ filter form ƒë·ªÉ ch·ªçn season, submit GET l·∫°i cho Controller

<form method="get" th:action="@{/clubs/statistics}">
    <input name="season" th:value="${season}" />
    <button>Filter</button>
</form>

<table>
  <tr>
    <th>Club</th><th>Wins</th><th>Draws</th><th>Losses</th><th>Points</th>
  </tr>
  <tr th:each="c : ${statsList}">
    <td th:text="${c.clubName}"></td>
    <td th:text="${c.wins}"></td>
    <td th:text="${c.draws}"></td>
    <td th:text="${c.losses}"></td>
    <td th:text="${c.points}"></td>
  </tr>
</table>

9Ô∏è‚É£ Data Flow

Browser g·ª≠i GET /club/{clubId}/statistics ho·∫∑c /clubs/statistics

Controller extract param ‚Üí g·ªçi Service

Service parse season, g·ªçi Repository

Repository ch·∫°y aggregation JPQL, tr·∫£ DTO(s)

Service enrich DTO(s) (goalDiff, winRate, points)

Controller addAttribute ‚Üí Thymeleaf render HTML

üîë Key Considerations

Aggregation tr√™n DB, tr√°nh load c·∫£ list Match

Index: match_start_time, club_id

DTO projection ‚Üí tr√°nh lazy loading + gi·∫£m coupling

Home/away c√≥ th·ªÉ d√πng CASE trong SUM n·∫øu c·∫ßn ph√¢n bi·ªát

Optional pagination cho t·∫•t c·∫£ CLB (ranking)

‚úÖ T√≥m t·∫Øt:
UC15 s·ª≠ d·ª•ng MVC chu·∫©n, repository t·∫≠p trung query + aggregation, service enrich DTO, controller add model, view render b·∫£ng th·ªëng k√™.
Logic UC15 kh√° gi·ªëng UC12/14 v·ªÅ c√°ch filter m√πa gi·∫£i, nh∆∞ng kh√°c bi·ªát l√†:

Aggregation thay v√¨ return list Match

Derived metrics (goalDifference, points, winRate)

DTO projection cho view
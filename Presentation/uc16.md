1️⃣ Goal

Người dùng muốn xem thông tin chi tiết của một cầu thủ:

Thông tin cá nhân: tên, vị trí, quốc tịch, sinh nhật

CLB hiện tại

Thống kê sự nghiệp: tổng số trận, bàn thắng, kiến tạo, thẻ

Lịch sử trận gần nhất

Lọc theo mùa giải (tuỳ chọn)

Kết quả trả về: HTML render (PlayerDetail.html)

2️⃣ Entry Point
GET /player/{playerId}?season=2025


playerId: path variable

season: query param (tùy chọn)

3️⃣ Layer Responsibilities
Layer	Nhiệm vụ
Controller	Nhận param, gọi service, add model attributes (player, stats, recentMatches, season), trả view PlayerDetail
Service	Chuẩn hóa input (season), fetch entity & aggregated stats, fetch recent matches, tính toán giá trị derived (ví dụ: averageGoalsPerMatch)
Repository	Truy xuất dữ liệu: PlayerRepo (findById, recent matches), PlayerStatsRepo (aggregatePlayerStats)
Entities	Player, Club, Match, MatchPlayerStat
DTO	PlayerStatisticsView truyền thống kê aggregated cho view
View	Thymeleaf: hiển thị thông tin cầu thủ, bảng thống kê, recent matches, filter form
4️⃣ Data Flow Sequence

Browser GET /player/{playerId}?season=2025

Controller:

Extract playerId và season

Gọi PlayerService.getPlayerDetails(playerId, season)

Service:

Parse season → Integer

PlayerRepo.findById(playerId) → Player entity

PlayerStatsRepo.aggregatePlayerStats(playerId, season) → PlayerStatisticsView DTO

PlayerRepo.findRecentMatchesByPlayer(playerId, season, limit=10) → List<Match>

Tính averageGoalsPerMatch và enrich DTO

Controller → add model attributes (player, stats, recentMatches, season)

View (Thymeleaf) → render thông tin chi tiết, bảng thống kê, recent matches

5️⃣ Class Coupling
Controller → Service → Repository → Entities
→ DTO
View ← Controller (model attributes only)


Controller chỉ phụ thuộc service

Service phụ thuộc repository, xử lý business + enrich DTO

Repository truy vấn DB thông qua JPA entities

View chỉ đọc DTO và entity reference

6️⃣ Repository Methods

PlayerRepo

findById(playerId) → trả Player entity

findRecentMatchesByPlayer(playerId, season, limit) → list Match gần nhất

JPQL query: join MatchPlayerStat → Match, filter theo playerId và season, order by matchStartTime DESC, limit 10

PlayerStatsRepo

aggregatePlayerStats(playerId, season) → trả DTO PlayerStatisticsView

JPQL: COUNT, SUM (matches, goals, assists, yellow/red cards), group by player

7️⃣ DTO — PlayerStatisticsView

Raw fields: totalMatches, totalGoals, totalAssists, totalYellowCards, totalRedCards

Derived: averageGoalsPerMatch (tính trong service)

Constructor nhận Number để tránh null issues từ aggregation JPQL

8️⃣ Entities

Player (UUID, fullname, birthday, position, nationality, Club)

Club (UUID, name, logo)

Match (UUID, startTime, description)

MatchPlayerStat (links player → match, stats: goals, assists, cards)

9️⃣ View — PlayerDetail.html (Thymeleaf)

Hiển thị thông tin cá nhân + CLB

Bảng thống kê (matches, goals, assists, cards, average goals/match)

Recent matches (10 trận gần nhất)

Filter form GET theo season

10️⃣ Key Considerations

Single responsibility: Controller HTTP, Service business logic, Repository DB access

DB-side aggregation → tăng hiệu năng, tránh load toàn bộ MatchPlayerStat

DTO projection → tránh lazy loading issues

Season filter optional

Indexes: player_id, match_start_time

Limit recent matches → tránh excessive data

Enrichment: service tính metrics derived

Error handling: Service throw exception nếu player không tồn tại, có thể dùng @ControllerAdvice xử lý

11️⃣ Summary Flow UC16
Request GET /player/{playerId}?season=2025
↓
Controller → extract params → call Service
↓
Service → parse season, fetch Player entity
→ fetch aggregated stats DTO
→ fetch recent matches
→ enrich DTO (average goals/match)
↓
Controller → add model attributes
↓
Thymeleaf → render PlayerDetail.html


Ưu điểm: tách biệt rõ ràng, aggregation DB → hiệu năng, DTO → tránh lazy loading, filter season dễ mở rộng.
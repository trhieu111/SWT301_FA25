<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head></head>

<body>
    <!-- templates/fragments/chatbox.html -->
    <div th:fragment="chatBoxFragment" id="chat-wrapper">
        <div id="chat-toggle" onclick="toggleChat()">ðŸ’¬ Chat vá»›i Admin</div>
        <div id="chat-box-container">
            <div id="chat-box-header">Há»— trá»£ trá»±c tuyáº¿n <span onclick="toggleChat()">âœ–</span></div>
            <div id="chat-box"></div>
            <input type="text" id="userId" placeholder="Nháº­p ID cá»§a báº¡n">
            <input type="text" id="message" placeholder="Nháº­p tin nháº¯n...">
            <button onclick="sendMessage()">Gá»­i</button>
        </div>

        <style>
            #chat-wrapper {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9999;
                font-family: Arial, sans-serif;
            }

            #chat-toggle {
                background: #37003c;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                cursor: pointer;
                font-weight: bold;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }

            #chat-box-container {
                display: none;
                width: 300px;
                max-height: 400px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
                overflow: hidden;
                flex-direction: column;
                margin-top: 10px;
            }

            #chat-box-header {
                background: #37003c;
                color: white;
                padding: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: bold;
            }

            #chat-box {
                height: 200px;
                overflow-y: auto;
                padding: 10px;
                border-top: 1px solid #eee;
                border-bottom: 1px solid #eee;
                font-size: 14px;
            }

            #chat-box-container input[type="text"] {
                width: 100%;
                padding: 8px;
                border: none;
                border-bottom: 1px solid #ddd;
                outline: none;
                font-size: 14px;
            }

            #chat-box-container button {
                width: 100%;
                padding: 8px;
                background: #37003c;
                color: white;
                border: none;
                cursor: pointer;
                font-weight: bold;
            }

            #chat-box-container button:hover {
                background: #5a1a5a;
            }
        </style>

        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyDyd5TZhM1w9tI6eFGBT6PRKX8aNpxpad0",
                authDomain: "mylea-fb2c4.firebaseapp.com",
                databaseURL: "https://mylea-fb2c4-default-rtdb.firebaseio.com",
                projectId: "mylea-fb2c4",
                storageBucket: "mylea-fb2c4.firebasestorage.app",
                messagingSenderId: "94061702332",
                appId: "1:94061702332:web:30538806b6d159d24534b9",
                measurementId: "G-H3PF6MWEXB"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            function sendMessage() {
                const userId = document.getElementById("userId").value;
                const message = document.getElementById("message").value;
                if (!userId || !message) return;
                db.ref("chat/" + userId).push({
                    text: message,
                    from: "user",
                    timestamp: Date.now()
                });
                document.getElementById("message").value = "";
            }

            function listenForMessages() {
                const userId = document.getElementById("userId").value;
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = "";

                db.ref("chat/" + userId).on("child_added", snapshot => {
                    const msg = snapshot.val();
                    const div = document.createElement("div");
                    div.textContent = `${msg.from === "admin" ? "ðŸ‘‘ Admin" : "ðŸ§‘ Báº¡n"}: ${msg.text}`;
                    chatBox.appendChild(div);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            }

            document.addEventListener("DOMContentLoaded", () => {
                const userIdField = document.getElementById("userId");
                userIdField.addEventListener("change", listenForMessages);
            });

            function toggleChat() {
                const box = document.getElementById("chat-box-container");
                const toggleBtn = document.getElementById("chat-toggle");
                if (box.style.display === "none" || box.style.display === "") {
                    box.style.display = "flex";
                    toggleBtn.style.display = "none";
                } else {
                    box.style.display = "none";
                    toggleBtn.style.display = "block";
                }
            }
        </script>
    </div>